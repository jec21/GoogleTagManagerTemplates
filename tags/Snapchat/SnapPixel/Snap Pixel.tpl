___INFO___

{
  "displayName": "Snap Pixel",
  "description": "Unofficial template for deploying the Snap Pixel.",
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1NuYXBQaXhlbC1TaW1vLUFoYXZh",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "displayName": "Snapchat (unofficial)",
    "id": "brand_dummy",
    "thumbnail": "data:image/png;base64,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"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "help": "You can get the Pixel ID from Ads Manager by clicking <strong>Setup my Pixel</strong> and copying the Pixel ID from the <strong>snaptr.init('&lt;PIXEL_ID&gt;', ....)</strong> snippet.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "name": "pixelId",
    "type": "TEXT",
    "valueHint": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  },
  {
    "selectItems": [
      {
        "displayValue": "ADD_BILLING",
        "value": "ADD_BILLING"
      },
      {
        "displayValue": "ADD_CART",
        "value": "ADD_CART"
      },
      {
        "displayValue": "PAGE_VIEW",
        "value": "PAGE_VIEW"
      },
      {
        "displayValue": "PURCHASE",
        "value": "PURCHASE"
      },
      {
        "displayValue": "SAVE",
        "value": "SAVE"
      },
      {
        "displayValue": "SEARCH",
        "value": "SEARCH"
      },
      {
        "displayValue": "SIGN_UP",
        "value": "SIGN_UP"
      },
      {
        "displayValue": "START_CHECKOUT",
        "value": "START_CHECKOUT"
      },
      {
        "displayValue": "VIEW_CONTENT",
        "value": "VIEW_CONTENT"
      }
    ],
    "displayName": "Event Name",
    "defaultValue": "PAGE_VIEW",
    "simpleValueType": true,
    "name": "eventName",
    "type": "SELECT"
  },
  {
    "displayName": "Configuration Parameters",
    "name": "configParamsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "configParams",
        "simpleTableColumns": [
          {
            "selectItems": [
              {
                "displayValue": "user_email",
                "value": "user_email"
              },
              {
                "displayValue": "user_phone_number",
                "value": "user_phone_number"
              },
              {
                "displayValue": "user_hashed_email",
                "value": "user_hashed_email"
              },
              {
                "displayValue": "user_hashed_phone_number",
                "value": "user_hashed_phone_number"
              }
            ],
            "defaultValue": "user_email",
            "displayName": "Parameter name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "displayName": "Event Parameters",
    "name": "eventParamsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "eventParams",
        "simpleTableColumns": [
          {
            "selectItems": [
              {
                "displayValue": "currency",
                "value": "currency"
              },
              {
                "displayValue": "description",
                "value": "description"
              },
              {
                "displayValue": "item_category",
                "value": "item_category"
              },
              {
                "displayValue": "item_ids",
                "value": "item_ids"
              },
              {
                "displayValue": "number_items",
                "value": "number_items"
              },
              {
                "displayValue": "payment_info_available",
                "value": "payment_info_available"
              },
              {
                "displayValue": "price",
                "value": "price"
              },
              {
                "displayValue": "search_string",
                "value": "search_string"
              },
              {
                "displayValue": "sign_up_method",
                "value": "sign_up_method"
              },
              {
                "displayValue": "success",
                "value": "success"
              },
              {
                "displayValue": "transaction_id",
                "value": "transaction_id"
              }
            ],
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snap_pixel_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snaptr"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snaptr.handleRequest"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snaptr.handleRequest.apply"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snaptr.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snaptr.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://sc-static.net/scevent.min.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// APIs
const injectScript = require('injectScript');
const makeTableMap = require('makeTableMap');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');
const setInWindow = require('setInWindow');
const createQueue = require('createQueue');

// Helpers
const endpoint = 'https://sc-static.net/scevent.min.js';
const snapPixelIds = copyFromWindow('snap_pixel_ids') || [];

// User data
const pixelId = data.pixelId;
const eventName = data.eventName;
const configParams = data.configParams ? makeTableMap(data.configParams, 'name', 'value') : {};
const eventParams = data.eventParams ? makeTableMap(data.eventParams, 'name', 'value') : {};

// Create the global handler
const getSnap = () => {
  let snaptr = copyFromWindow('snaptr');
  if (snaptr) {
    return snaptr;
  }
  setInWindow('snaptr', function() {
    const handleRequest = copyFromWindow('snaptr.handleRequest');
    if (handleRequest) {
      callInWindow('snaptr.handleRequest.apply', null, arguments);
    } else {
      callInWindow('snaptr.queue.push', arguments);
    }
  }, true);
  createQueue('snaptr.queue');
  return copyFromWindow('snaptr');
};

// Initialize
const snaptr = getSnap();
if (snapPixelIds.indexOf(data.pixelId) === -1) {
  snaptr('init', data.pixelId, configParams);
  snapPixelIds.push(data.pixelId);
  setInWindow('snap_pixel_ids', snapPixelIds, true);
}

// Fire event
snaptr('track', eventName, eventParams);

injectScript(endpoint, data.gtmOnSuccess, data.gtmOnFailure, 'snaptr');


___NOTES___

Created on 21/08/2019, 15:14:54
